---
title: "Chapter 3"
output: html_notebook
---
Chapter 3
```{r}
library(xts)
library(lubridate)
library(quantmod)
library(tidyverse)
library(tibbletime)
library(timetk)

YEARS_BACK <- 5
symbols <-
  c("OLTYX",
    "OEGYX",
    "RDIV",
    "RMUYX",
    "ESGF",
    "OMFL",
    "OIMYX",
    "OIGYX",
    "GLVYX",
    "MIGYX")

source("../helper_functions.r")

```

```{r}

raw_symbols <-
  getSymbols(
    symbols,
    src = 'yahoo',
    from = Sys.Date() - dyears(5),
    to = Sys.Date(),
    auto.assign = TRUE,
    warnings = TRUE
  )

raw_prices <- raw_symbols %>%
  map( ~ Ad(get(.))) %>%
  reduce(merge) %>%
  `colnames<-`(symbols)

save(raw_prices,file="../data/raw_prices.rdata")
```

```{r}

load("../data/raw_prices.rdata")
```

```{r}
prices<-timetk::tk_tbl(raw_prices) %>%
  rename(date=index) %>% 
  tibbletime::as_tbl_time(index=date) 

#monthlyize
prices <- prices %>% tibbletime::as_period("monthly",side="end")

#tidyfy it
prices <- prices %>% gather(symbol,price,-date) %>% group_by(symbol)

#one symbol has bad data for six months.  It looks like the NAV is doubled. Fix.
prices <- prices %>% mutate(price=ifelse((symbol=="OLTYX" & price > 6),price/2,price))

#create return series
returns <- prices %>% transmute(date=date,return=log(price)/lag(log(price))-1) %>% slice(-1)

returns
```


```{r eval=FALSE, include=FALSE}
#Make portfolio  Load positions
# not part of git
positions<-read_csv("../data/Positions.csv")

#filter out cash
positions <- positions %>% filter(`Asset Strategy Detail` != "Cash")
#convert to percentages
portfolio<-positions %>% mutate(weight=Value/sum(Value)) %>%
  select(starts_with("Asset"),Description,Ticker,weight) %>% 
  rename(symbol=Ticker)

portfolio
save(portfolio,file="../data/portfolio.rdata")
```

```{r}
# this file is in repo.  Dollars are missing.  Only weights.
load("../data/portfolio.rdata")

ggplot(portfolio,aes(symbol,weight,fill=`Asset Class`)) + geom_col()
```
OR
```{r}
ggplot(portfolio,aes(`Asset Class`,weight,fill=symbol)) + geom_col()

```

```{r}

portfolio_return<-returns %>%
  subset_year(2012) %>% 
  left_join(select(portfolio,symbol,weight)) %>% 
  group_by(date) %>% 
  summarise(return=sum(return*weight)) %>% 
  mutate(symbol="Portfolio") %>% 
  group_by(symbol)
  
returns <- returns %>% bind_rows(portfolio_return)
gg<-returns %>%  
  subset_year(2012) %>% 
  chart_cum_returns(name_col = "symbol")

gg
```
Volatility
```{r}
returns %>% subset_year(2012) %>% 
  group_by(symbol) %>% 
  summarise(vol_pct=volatility(return))
```

```{r}
volatility(portfolio_return$portfolio_return,n=12)
```


Correlation Matrix
```{r}

returns %>% subset_year(2012) %>% 
  spread(symbol,return) %>% 
  select(-date) %>% 
  cov()  %>% 
  cov2cor() %>% 
  round(digits = 2) %>% 
  {.}
```

